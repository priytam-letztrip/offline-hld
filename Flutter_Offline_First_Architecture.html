<h1
id="flutter-offline-first-architecture-with-bloc-hive-sync-engine">Flutter
Offline-First Architecture with BLoC + Hive + Sync Engine</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ol type="1">
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#technology-stack">Technology Stack</a></li>
<li><a href="#system-components">System Components</a></li>
<li><a href="#data-flow-diagrams">Data Flow Diagrams</a></li>
<li><a href="#implementation-details">Implementation Details</a></li>
<li><a href="#bloc-state-management">BLoC State Management</a></li>
<li><a href="#conflict-resolution">Conflict Resolution</a></li>
<li><a href="#project-structure">Project Structure</a></li>
<li><a href="#code-examples">Code Examples</a></li>
<li><a href="#best-practices">Best Practices</a></li>
</ol>
<hr />
<h2 id="architecture-overview">Architecture Overview</h2>
<p>The system is designed as a <strong>Flutter offline-first
application</strong> that ensures data availability and consistency
across online/offline states using Hive for local persistence and a
dedicated sync engine for server synchronization.</p>
<h3 id="core-architectural-principles">Core Architectural
Principles</h3>
<ul>
<li><strong>Offline-First</strong>: App functions fully offline, with
sync as enhancement</li>
<li><strong>Eventual Consistency</strong>: Data eventually syncs when
network available</li>
<li><strong>Conflict Resolution</strong>: Multiple strategies for
handling data conflicts</li>
<li><strong>Separation of Concerns</strong>: Clear layer separation for
maintainability</li>
<li><strong>Fault Tolerance</strong>: Graceful handling of network
failures and retries</li>
</ul>
<hr />
<h2 id="technology-stack">Technology Stack</h2>
<h3 id="complete-technology-stack-with-bloc">Complete Technology Stack
with BLoC</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                       │
├─────────────────────────────────────────────────────────────┤
│ • Flutter UI Framework                                      │
│ • Material Design / Cupertino                               │
│ • Custom Widgets &amp; Components                               │
│ • Sync Status Indicators                                    │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  STATE MANAGEMENT LAYER                     │
├─────────────────────────────────────────────────────────────┤
│ • BLoC (Business Logic Component)                          │
│ • Cubit (Lightweight BLoC)                                 │
│ • Event Sourcing Pattern                                   │
│ • Stream Controllers                                        │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   BUSINESS LOGIC LAYER                      │
├─────────────────────────────────────────────────────────────┤
│ • Repository Pattern                                        │
│ • Use Cases / Interactors                                   │
│ • Sync Engine                                               │
│ • Conflict Resolution Engine                                │
│ • Retry Manager                                             │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    DATA ACCESS LAYER                        │
├─────────────────────────────────────────────────────────────┤
│ • Hive Local Storage                                        │
│ • Sync Queue Management                                     │
│ • Data Adapters &amp; Serialization                             │
│ • Caching Layer                                             │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   INFRASTRUCTURE LAYER                      │
├─────────────────────────────────────────────────────────────┤
│ • Connectivity Service                                      │
│ • Background Sync Service                                   │
│ • Network Service (Dio)                                     │
│ • WorkManager (Background Tasks)                            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    EXTERNAL LAYER                           │
├─────────────────────────────────────────────────────────────┤
│ • Remote API (REST/GraphQL)                                │
│ • Cloud Storage                                             │
│ • Push Notifications                                        │
│ • Analytics &amp; Crash Reporting                               │
└─────────────────────────────────────────────────────────────┘</code></pre>
<h3 id="detailed-bloc-layer-breakdown">Detailed BLoC Layer
Breakdown</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    FLUTTER APP STACK (BLOC)                 │
├─────────────────────────────────────────────────────────────┤
│  UI LAYER                                                   │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │   Screens       │ │   Widgets       │ │   Components    ││
│  │   • Home        │ │   • NoteCard    │ │   • SyncStatus  ││
│  │   • Notes       │ │   • UserCard    │ │   • ConflictUI  ││
│  │   • Settings    │ │   • SyncButton  │ │   • RetryDialog ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  BLOC STATE MANAGEMENT LAYER                               │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │     BLOCS       │ │     CUBITS      │ │     EVENTS      ││
│  │   • NotesBloc   │ │   • SyncCubit   │ │   • NoteEvent   ││
│  │   • UsersBloc   │ │   • ConflictCubit│ │   • SyncEvent   ││
│  │   • SyncBloc    │ │   • RetryCubit  │ │   • UserEvent   ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │     STATES      │ │   REPOSITORIES  │ │   USE CASES     ││
│  │   • NoteState   │ │   • NoteRepo    │ │   • CreateNote  ││
│  │   • SyncState   │ │   • UserRepo    │ │   • UpdateNote  ││
│  │   • UserState   │ │   • SyncRepo    │ │   • DeleteNote  ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  BUSINESS LOGIC LAYER                                       │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │   SYNC ENGINE   │ │ CONFLICT RES.   │ │   RETRY MGR     ││
│  │   • QueueMgr    │ │   • LWW         │ │   • Exponential ││
│  │   • BatchSync   │ │   • ServerWins  │ │   • Backoff     ││
│  │   • DeltaSync   │ │   • FieldMerge  │ │   • MaxRetries  ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  DATA LAYER                                                 │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │   HIVE BOXES    │ │   SYNC QUEUE    │ │   ADAPTERS      ││
│  │   • NotesBox    │ │   • ActionQueue │ │   • NoteAdapter ││
│  │   • UsersBox    │ │   • RetryQueue  │ │   • UserAdapter ││
│  │   • ConfigBox   │ │   • ConflictQ   │ │   • SyncAdapter ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  INFRASTRUCTURE LAYER                                       │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │   CONNECTIVITY  │ │   BACKGROUND    │ │   NETWORK       ││
│  │   • Monitor     │ │   • WorkManager │ │   • Dio Client  ││
│  │   • Listener    │ │   • SyncTask    │ │   • Interceptors││
│  │   • Status      │ │   • RetryTask   │ │   • Auth        ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="system-components">System Components</h2>
<h3 id="model-layer">1. Model Layer</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Base sync metadata</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncMeta <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> DateTime lastUpdated;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">bool</span> isSynced;</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span><span class="op">?</span> conflictFlag;</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">int</span> retryCount;</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> DateTime<span class="op">?</span> lastSyncAttempt;</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Entity with sync metadata</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> SyncableEntity <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span> <span class="kw">get</span> id;</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  SyncMeta <span class="kw">get</span> syncMeta;</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> toSyncPayload();</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> updateSyncMeta(SyncMeta meta);</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="hive-storage-structure">2. Hive Storage Structure</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Main entity boxes</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteBox <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="at">const</span> <span class="dt">String</span> name <span class="op">=</span> <span class="st">&#39;notes&#39;</span>;</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Stores actual Note entities</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserBox <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="at">const</span> <span class="dt">String</span> name <span class="op">=</span> <span class="st">&#39;users&#39;</span>;</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Stores actual User entities</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync queue box</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncQueueBox <span class="op">{</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="at">const</span> <span class="dt">String</span> name <span class="op">=</span> <span class="st">&#39;sync_queue&#39;</span>;</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Stores SyncAction entities</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync action types</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> SyncActionType <span class="op">{</span> create<span class="op">,</span> update<span class="op">,</span> delete <span class="op">}</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncAction <span class="op">{</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> id;</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncActionType type;</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> entityType;</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> entityId;</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> payload;</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> DateTime timestamp;</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">int</span> retryCount;</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncStatus status;</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="repository-layer">3. Repository Layer</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> BaseRepository<span class="op">&lt;</span>T <span class="kw">extends</span> SyncableEntity<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> create(T entity);</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> update(T entity);</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> delete(<span class="dt">String</span> id);</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Stream</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> watchAll();</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Stream</span><span class="op">&lt;</span>T<span class="op">?&gt;</span> watchById(<span class="dt">String</span> id);</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Sync-specific methods</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> markAsSynced(<span class="dt">String</span> id);</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> markAsConflict(<span class="dt">String</span> id<span class="op">,</span> <span class="dt">String</span> conflictReason);</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>T<span class="op">&gt;&gt;</span> getUnsyncedEntities();</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="sync-engine-architecture">4. Sync Engine Architecture</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncEngine <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ConnectivityService _connectivity;</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncQueueService _syncQueue;</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ConflictResolver _conflictResolver;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> RetryManager _retryManager;</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Core sync methods</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> startSync();</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> stopSync();</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> processSyncQueue();</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> syncEntity(SyncAction action);</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Conflict resolution</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>SyncResult<span class="op">&gt;</span> resolveConflict(SyncAction action<span class="op">,</span> ServerResponse response);</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="data-flow-diagrams">Data Flow Diagrams</h2>
<h3 id="offline-data-flow-diagram">1. Offline Data Flow Diagram</h3>
<figure>
<img src="oflinedataflow.png" alt="Offline Data Flow" />
<figcaption aria-hidden="true">Offline Data Flow</figcaption>
</figure>
<h3 id="online-data-flow-diagram">2. Online Data Flow Diagram</h3>
<figure>
<img src="onlinedataflow.png" alt="Online Data Flow" />
<figcaption aria-hidden="true">Online Data Flow</figcaption>
</figure>
<h3 id="offline-sequence-diagram">3. Offline Sequence Diagram</h3>
<figure>
<img src="offlineseq.png" alt="Offline Sequence" />
<figcaption aria-hidden="true">Offline Sequence</figcaption>
</figure>
<h3 id="online-sequence-diagram">4. Online Sequence Diagram</h3>
<figure>
<img src="onlineseq.png" alt="Online Sequence" />
<figcaption aria-hidden="true">Online Sequence</figcaption>
</figure>
<h3 id="end-to-end-flow-diagram">5. End-to-End Flow Diagram</h3>
<figure>
<img src="ete.png" alt="End-to-End Flow" />
<figcaption aria-hidden="true">End-to-End Flow</figcaption>
</figure>
<h3 id="bloc-event-flow-architecture">3. BLoC Event Flow
Architecture</h3>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                    BLOC EVENT FLOW                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │    USER     │───►│     UI      │───►│    BLOC     │     │
│  │   ACTION    │    │   LAYER     │    │   EVENT     │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                              │                   │         │
│                              ▼                   ▼         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   SYNC      │◄───│ REPOSITORY  │◄───│   BLOC      │     │
│  │   QUEUE     │    │   LAYER     │    │  HANDLER    │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         ▲                   │                   │         │
│         │                   ▼                   ▼         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   SYNC      │    │    HIVE     │    │   BLOC      │     │
│  │   ENGINE    │    │ MAIN BOXES  │    │   STATE     │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   ▲                   │         │
│         └───────────────────┼───────────────────┘         │
│                             │                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │CONNECTIVITY │    │  RETRY      │    │   UI        │     │
│  │  SERVICE    │    │  MANAGER    │    │ REBUILD     │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘</code></pre>
<hr />
<h2 id="bloc-state-management">BLoC State Management</h2>
<h3 id="bloc-structure">1. BLoC Structure</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Events</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> NoteEvent <span class="op">{}</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddNoteEvent <span class="kw">extends</span> NoteEvent <span class="op">{</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Note note;</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  AddNoteEvent(<span class="kw">this</span><span class="op">.</span>note);</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UpdateNoteEvent <span class="kw">extends</span> NoteEvent <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Note note;</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  UpdateNoteEvent(<span class="kw">this</span><span class="op">.</span>note);</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DeleteNoteEvent <span class="kw">extends</span> NoteEvent <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> noteId;</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  DeleteNoteEvent(<span class="kw">this</span><span class="op">.</span>noteId);</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncNotesEvent <span class="kw">extends</span> NoteEvent <span class="op">{}</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">// States</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> NoteState <span class="op">{}</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteInitial <span class="kw">extends</span> NoteState <span class="op">{}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteLoading <span class="kw">extends</span> NoteState <span class="op">{}</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteLoaded <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;</span> notes;</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncStatus syncStatus;</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  NoteLoaded(<span class="kw">this</span><span class="op">.</span>notes<span class="op">,</span> <span class="kw">this</span><span class="op">.</span>syncStatus);</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteAdded <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Note note;</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">bool</span> isSynced;</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  NoteAdded(<span class="kw">this</span><span class="op">.</span>note<span class="op">,</span> <span class="kw">this</span><span class="op">.</span>isSynced);</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteUpdated <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Note note;</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">bool</span> isSynced;</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  NoteUpdated(<span class="kw">this</span><span class="op">.</span>note<span class="op">,</span> <span class="kw">this</span><span class="op">.</span>isSynced);</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteDeleted <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> noteId;</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  NoteDeleted(<span class="kw">this</span><span class="op">.</span>noteId);</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteSyncInProgress <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;</span> notes;</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  NoteSyncInProgress(<span class="kw">this</span><span class="op">.</span>notes);</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteSyncComplete <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;</span> notes;</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>  NoteSyncComplete(<span class="kw">this</span><span class="op">.</span>notes);</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteSyncError <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> error;</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;</span> notes;</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>  NoteSyncError(<span class="kw">this</span><span class="op">.</span>error<span class="op">,</span> <span class="kw">this</span><span class="op">.</span>notes);</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteConflictDetected <span class="kw">extends</span> NoteState <span class="op">{</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Note localNote;</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Note serverNote;</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> conflictReason;</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>  NoteConflictDetected(<span class="kw">this</span><span class="op">.</span>localNote<span class="op">,</span> <span class="kw">this</span><span class="op">.</span>serverNote<span class="op">,</span> <span class="kw">this</span><span class="op">.</span>conflictReason);</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="bloc-implementation">2. BLoC Implementation</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteBloc <span class="kw">extends</span> Bloc<span class="op">&lt;</span>NoteEvent<span class="op">,</span> NoteState<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> NoteRepository _noteRepository;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncEngine _syncEngine;</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ConnectivityService _connectivityService;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  NoteBloc(<span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    required NoteRepository noteRepository<span class="op">,</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    required SyncEngine syncEngine<span class="op">,</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    required ConnectivityService connectivityService<span class="op">,</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>) <span class="op">:</span> _noteRepository <span class="op">=</span> noteRepository<span class="op">,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>       _syncEngine <span class="op">=</span> syncEngine<span class="op">,</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>       _connectivityService <span class="op">=</span> connectivityService<span class="op">,</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>       <span class="kw">super</span>(NoteInitial()) <span class="op">{</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">on</span><span class="op">&lt;</span>AddNoteEvent<span class="op">&gt;</span>(_onAddNote);</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">on</span><span class="op">&lt;</span>UpdateNoteEvent<span class="op">&gt;</span>(_onUpdateNote);</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">on</span><span class="op">&lt;</span>DeleteNoteEvent<span class="op">&gt;</span>(_onDeleteNote);</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">on</span><span class="op">&lt;</span>SyncNotesEvent<span class="op">&gt;</span>(_onSyncNotes);</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen to connectivity changes</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    _connectivityService<span class="op">.</span>connectivityStream<span class="op">.</span>listen((isConnected) <span class="op">{</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (isConnected) <span class="op">{</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        add(SyncNotesEvent());</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>);</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _onAddNote(AddNoteEvent event<span class="op">,</span> Emitter<span class="op">&lt;</span>NoteState<span class="op">&gt;</span> emit) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      emit(NoteLoading());</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Save note locally</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _noteRepository<span class="op">.</span>addNote(event<span class="op">.</span>note);</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check if online for immediate sync</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> isOnline <span class="op">=</span> <span class="at">await</span> _connectivityService<span class="op">.</span>isConnected;</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (isOnline) <span class="op">{</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Trigger immediate sync</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">await</span> _syncEngine<span class="op">.</span>syncEntity(event<span class="op">.</span>note);</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        emit(NoteAdded(event<span class="op">.</span>note<span class="op">,</span> <span class="cn">true</span>));</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Note will be synced when online</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        emit(NoteAdded(event<span class="op">.</span>note<span class="op">,</span> <span class="cn">false</span>));</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load updated notes</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> notes <span class="op">=</span> <span class="at">await</span> _noteRepository<span class="op">.</span>getAllNotes();</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>      emit(NoteLoaded(notes<span class="op">,</span> SyncStatus<span class="op">.</span>idle));</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>      emit(NoteSyncError(e<span class="op">.</span>toString()<span class="op">,</span> []));</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _onSyncNotes(SyncNotesEvent event<span class="op">,</span> Emitter<span class="op">&lt;</span>NoteState<span class="op">&gt;</span> emit) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> notes <span class="op">=</span> <span class="at">await</span> _noteRepository<span class="op">.</span>getAllNotes();</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>      emit(NoteSyncInProgress(notes));</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _syncEngine<span class="op">.</span>processSyncQueue();</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> updatedNotes <span class="op">=</span> <span class="at">await</span> _noteRepository<span class="op">.</span>getAllNotes();</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>      emit(NoteSyncComplete(updatedNotes));</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> notes <span class="op">=</span> <span class="at">await</span> _noteRepository<span class="op">.</span>getAllNotes();</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>      emit(NoteSyncError(e<span class="op">.</span>toString()<span class="op">,</span> notes));</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="conflict-resolution">Conflict Resolution</h2>
<h3 id="conflict-resolution-strategies">1. Conflict Resolution
Strategies</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> ConflictResolver <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>ConflictResolution<span class="op">&gt;</span> resolve(ConflictContext context);</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LastWriteWinsResolver <span class="kw">implements</span> ConflictResolver <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>ConflictResolution<span class="op">&gt;</span> resolve(ConflictContext context) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> localTime <span class="op">=</span> context<span class="op">.</span>localEntity<span class="op">.</span>syncMeta<span class="op">.</span>lastUpdated;</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> serverTime <span class="op">=</span> context<span class="op">.</span>serverResponse<span class="op">.</span>serverTimestamp;</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (localTime<span class="op">.</span>isAfter(serverTime)) <span class="op">{</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> ConflictResolution<span class="op">.</span>keepLocal;</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> ConflictResolution<span class="op">.</span>acceptServer;</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ServerWinsResolver <span class="kw">implements</span> ConflictResolver <span class="op">{</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>ConflictResolution<span class="op">&gt;</span> resolve(ConflictContext context) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ConflictResolution<span class="op">.</span>acceptServer;</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FieldLevelMergeResolver <span class="kw">implements</span> ConflictResolver <span class="op">{</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span>ConflictResolution<span class="op">&gt;</span> resolve(ConflictContext context) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Implement field-level merging logic</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> mergedData <span class="op">=</span> _mergeFields(</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span>localEntity<span class="op">.</span>toSyncPayload()<span class="op">,</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      context<span class="op">.</span>serverResponse<span class="op">.</span>data<span class="op">,</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ConflictResolution<span class="op">.</span>merge(mergedData);</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> _mergeFields(</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> local<span class="op">,</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> server<span class="op">,</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">{</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Custom merge logic based on field types</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> merged <span class="op">=</span> <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;.</span>from(local);</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Example: merge tags arrays</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (local[<span class="st">&#39;tags&#39;</span>] <span class="kw">is</span> <span class="dt">List</span> <span class="op">&amp;&amp;</span> server[<span class="st">&#39;tags&#39;</span>] <span class="kw">is</span> <span class="dt">List</span>) <span class="op">{</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> localTags <span class="op">=</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;.</span>from(local[<span class="st">&#39;tags&#39;</span>]);</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> serverTags <span class="op">=</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;.</span>from(server[<span class="st">&#39;tags&#39;</span>]);</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>      merged[<span class="st">&#39;tags&#39;</span>] <span class="op">=</span> [<span class="op">...</span>localTags<span class="op">,</span> <span class="op">...</span>serverTags]<span class="op">.</span>toSet()<span class="op">.</span>toList();</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Example: keep server timestamp for lastUpdated</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">&#39;lastUpdated&#39;</span>] <span class="op">=</span> server[<span class="st">&#39;lastUpdated&#39;</span>];</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> merged;</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="conflict-resolution-context">2. Conflict Resolution Context</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConflictContext <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncableEntity localEntity;</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ServerResponse serverResponse;</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> conflictReason;</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> conflictFields;</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  ConflictContext(<span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>localEntity<span class="op">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>serverResponse<span class="op">,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>conflictReason<span class="op">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>conflictFields<span class="op">,</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>);</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> ConflictResolution <span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  keepLocal<span class="op">,</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  acceptServer<span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  merge(<span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> mergedData)<span class="op">,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  requireUserInput<span class="op">,</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConflictResolutionResult <span class="op">{</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ConflictResolution resolution;</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span><span class="op">?</span> reason;</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;?</span> mergedData;</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  ConflictResolutionResult(<span class="op">{</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>resolution<span class="op">,</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>reason<span class="op">,</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>mergedData<span class="op">,</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>);</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="project-structure">Project Structure</h2>
<pre><code>lib/
├── core/
│   ├── models/
│   │   ├── sync_meta.dart
│   │   └── syncable_entity.dart
│   ├── storage/
│   │   ├── hive_service.dart
│   │   ├── sync_queue_service.dart
│   │   └── box_registry.dart
│   ├── sync/
│   │   ├── sync_engine.dart
│   │   ├── conflict_resolver.dart
│   │   └── retry_manager.dart
│   ├── connectivity/
│   │   └── connectivity_service.dart
│   └── errors/
│       ├── sync_exceptions.dart
│       └── conflict_exceptions.dart
├── features/
│   ├── notes/
│   │   ├── models/
│   │   │   └── note.dart
│   │   ├── repositories/
│   │   │   └── note_repository.dart
│   │   ├── bloc/
│   │   │   ├── note_bloc.dart
│   │   │   ├── note_event.dart
│   │   │   └── note_state.dart
│   │   ├── widgets/
│   │   │   ├── note_card.dart
│   │   │   ├── sync_status_indicator.dart
│   │   │   └── conflict_resolution_dialog.dart
│   │   └── screens/
│   │       └── notes_screen.dart
│   └── users/
│       ├── models/
│       │   └── user.dart
│       ├── repositories/
│       │   └── user_repository.dart
│       ├── bloc/
│       │   ├── user_bloc.dart
│       │   ├── user_event.dart
│       │   └── user_state.dart
│       └── screens/
│           └── users_screen.dart
├── services/
│   ├── api/
│   │   └── remote_api.dart
│   └── sync/
│       └── background_sync_service.dart
├── shared/
│   ├── widgets/
│   │   ├── loading_widget.dart
│   │   ├── error_widget.dart
│   │   └── retry_button.dart
│   └── utils/
│       ├── date_utils.dart
│       └── validation_utils.dart
└── main.dart</code></pre>
<hr />
<h2 id="code-examples">Code Examples</h2>
<h3 id="hive-adapter-implementation">1. Hive Adapter Implementation</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>@HiveType(typeId<span class="op">:</span> <span class="dv">0</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Note <span class="kw">extends</span> SyncableEntity <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  @HiveField(<span class="dv">0</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> id;</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  @HiveField(<span class="dv">1</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> title;</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  @HiveField(<span class="dv">2</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> content;</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  @HiveField(<span class="dv">3</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncMeta syncMeta;</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  @HiveField(<span class="dv">4</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;</span> tags;</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  @HiveField(<span class="dv">5</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> DateTime createdAt;</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  Note(<span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>id<span class="op">,</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>title<span class="op">,</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>content<span class="op">,</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>syncMeta<span class="op">,</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>tags <span class="op">=</span> <span class="at">const</span> []<span class="op">,</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>createdAt<span class="op">,</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>);</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> toSyncPayload() <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;id&#39;</span><span class="op">:</span> id<span class="op">,</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;title&#39;</span><span class="op">:</span> title<span class="op">,</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;content&#39;</span><span class="op">:</span> content<span class="op">,</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;tags&#39;</span><span class="op">:</span> tags<span class="op">,</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;createdAt&#39;</span><span class="op">:</span> createdAt<span class="op">.</span>toIso8601String()<span class="op">,</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lastUpdated&#39;</span><span class="op">:</span> syncMeta<span class="op">.</span>lastUpdated<span class="op">.</span>toIso8601String()<span class="op">,</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> updateSyncMeta(SyncMeta meta) <span class="op">{</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update sync metadata</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  Note copyWith(<span class="op">{</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">String</span><span class="op">?</span> id<span class="op">,</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">String</span><span class="op">?</span> title<span class="op">,</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">String</span><span class="op">?</span> content<span class="op">,</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    SyncMeta<span class="op">?</span> syncMeta<span class="op">,</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">List</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;?</span> tags<span class="op">,</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    DateTime<span class="op">?</span> createdAt<span class="op">,</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>) <span class="op">{</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Note(</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>      id<span class="op">:</span> id <span class="op">??</span> <span class="kw">this</span><span class="op">.</span>id<span class="op">,</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>      title<span class="op">:</span> title <span class="op">??</span> <span class="kw">this</span><span class="op">.</span>title<span class="op">,</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>      content<span class="op">:</span> content <span class="op">??</span> <span class="kw">this</span><span class="op">.</span>content<span class="op">,</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>      syncMeta<span class="op">:</span> syncMeta <span class="op">??</span> <span class="kw">this</span><span class="op">.</span>syncMeta<span class="op">,</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>      tags<span class="op">:</span> tags <span class="op">??</span> <span class="kw">this</span><span class="op">.</span>tags<span class="op">,</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>      createdAt<span class="op">:</span> createdAt <span class="op">??</span> <span class="kw">this</span><span class="op">.</span>createdAt<span class="op">,</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="repository-implementation">2. Repository Implementation</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NoteRepository <span class="kw">implements</span> BaseRepository<span class="op">&lt;</span>Note<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> HiveService _hiveService;</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncQueueService _syncQueue;</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> ConnectivityService _connectivity;</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  NoteRepository(<span class="op">{</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    required HiveService hiveService<span class="op">,</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    required SyncQueueService syncQueue<span class="op">,</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    required ConnectivityService connectivity<span class="op">,</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>) <span class="op">:</span> _hiveService <span class="op">=</span> hiveService<span class="op">,</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>       _syncQueue <span class="op">=</span> syncQueue<span class="op">,</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>       _connectivity <span class="op">=</span> connectivity;</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> create(Note note) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save to Hive</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">await</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>put(note<span class="op">.</span>id<span class="op">,</span> note);</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to sync queue if offline</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="at">await</span> _connectivity<span class="op">.</span>isConnected) <span class="op">{</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _syncQueue<span class="op">.</span>enqueue(SyncAction(</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        id<span class="op">:</span> Uuid()<span class="op">.</span>v4()<span class="op">,</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        type<span class="op">:</span> SyncActionType<span class="op">.</span>create<span class="op">,</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        entityType<span class="op">:</span> <span class="st">&#39;Note&#39;</span><span class="op">,</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        entityId<span class="op">:</span> note<span class="op">.</span>id<span class="op">,</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        payload<span class="op">:</span> note<span class="op">.</span>toSyncPayload()<span class="op">,</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        retryCount<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        status<span class="op">:</span> SyncStatus<span class="op">.</span>pending<span class="op">,</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>      ));</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> update(Note note) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update in Hive</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">await</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>put(note<span class="op">.</span>id<span class="op">,</span> note);</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to sync queue if offline</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="at">await</span> _connectivity<span class="op">.</span>isConnected) <span class="op">{</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _syncQueue<span class="op">.</span>enqueue(SyncAction(</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        id<span class="op">:</span> Uuid()<span class="op">.</span>v4()<span class="op">,</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        type<span class="op">:</span> SyncActionType<span class="op">.</span>update<span class="op">,</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        entityType<span class="op">:</span> <span class="st">&#39;Note&#39;</span><span class="op">,</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        entityId<span class="op">:</span> note<span class="op">.</span>id<span class="op">,</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        payload<span class="op">:</span> note<span class="op">.</span>toSyncPayload()<span class="op">,</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>        retryCount<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        status<span class="op">:</span> SyncStatus<span class="op">.</span>pending<span class="op">,</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>      ));</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> delete(<span class="dt">String</span> id) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Delete from Hive</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">await</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>delete(id);</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to sync queue if offline</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="at">await</span> _connectivity<span class="op">.</span>isConnected) <span class="op">{</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _syncQueue<span class="op">.</span>enqueue(SyncAction(</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        id<span class="op">:</span> Uuid()<span class="op">.</span>v4()<span class="op">,</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        type<span class="op">:</span> SyncActionType<span class="op">.</span>delete<span class="op">,</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>        entityType<span class="op">:</span> <span class="st">&#39;Note&#39;</span><span class="op">,</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>        entityId<span class="op">:</span> id<span class="op">,</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>        payload<span class="op">:</span> <span class="op">{</span><span class="st">&#39;id&#39;</span><span class="op">:</span> id<span class="op">},</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>        retryCount<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        status<span class="op">:</span> SyncStatus<span class="op">.</span>pending<span class="op">,</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>      ));</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Stream</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;&gt;</span> watchAll() <span class="op">{</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>watch()<span class="op">.</span>map((box) <span class="op">{</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> box<span class="op">.</span>values<span class="op">.</span>cast<span class="op">&lt;</span>Note<span class="op">&gt;</span>()<span class="op">.</span>toList();</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>);</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Stream</span><span class="op">&lt;</span>Note<span class="op">?&gt;</span> watchById(<span class="dt">String</span> id) <span class="op">{</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>watch()<span class="op">.</span>map((box) <span class="op">{</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> box<span class="op">.</span><span class="kw">get</span>(id) <span class="kw">as</span> Note<span class="op">?</span>;</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>);</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> markAsSynced(<span class="dt">String</span> id) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> note <span class="op">=</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span><span class="kw">get</span>(id) <span class="kw">as</span> Note<span class="op">?</span>;</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (note <span class="op">!=</span> <span class="cn">null</span>) <span class="op">{</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> updatedNote <span class="op">=</span> note<span class="op">.</span>copyWith(</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>        syncMeta<span class="op">:</span> SyncMeta(</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>          lastUpdated<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>          isSynced<span class="op">:</span> <span class="cn">true</span><span class="op">,</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>          conflictFlag<span class="op">:</span> <span class="cn">null</span><span class="op">,</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>          retryCount<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>          lastSyncAttempt<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>put(id<span class="op">,</span> updatedNote);</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> markAsConflict(<span class="dt">String</span> id<span class="op">,</span> <span class="dt">String</span> conflictReason) <span class="at">async</span> <span class="op">{</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> note <span class="op">=</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span><span class="kw">get</span>(id) <span class="kw">as</span> Note<span class="op">?</span>;</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (note <span class="op">!=</span> <span class="cn">null</span>) <span class="op">{</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">final</span> updatedNote <span class="op">=</span> note<span class="op">.</span>copyWith(</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>        syncMeta<span class="op">:</span> SyncMeta(</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>          lastUpdated<span class="op">:</span> note<span class="op">.</span>syncMeta<span class="op">.</span>lastUpdated<span class="op">,</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>          isSynced<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>          conflictFlag<span class="op">:</span> conflictReason<span class="op">,</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>          retryCount<span class="op">:</span> note<span class="op">.</span>syncMeta<span class="op">.</span>retryCount<span class="op">,</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>          lastSyncAttempt<span class="op">:</span> DateTime<span class="op">.</span>now()<span class="op">,</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>      );</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">await</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>put(id<span class="op">,</span> updatedNote);</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Future</span><span class="op">&lt;</span><span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;&gt;</span> getUnsyncedEntities() <span class="at">async</span> <span class="op">{</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> _hiveService<span class="op">.</span>notesBox<span class="op">.</span>values</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>cast<span class="op">&lt;</span>Note<span class="op">&gt;</span>()</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>where((note) <span class="op">=&gt;</span> <span class="op">!</span>note<span class="op">.</span>syncMeta<span class="op">.</span>isSynced)</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>toList();</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ui-integration-with-bloc">3. UI Integration with BLoC</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesScreen <span class="kw">extends</span> StatelessWidget <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) <span class="op">{</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> BlocBuilder<span class="op">&lt;</span>NoteBloc<span class="op">,</span> NoteState<span class="op">&gt;</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      builder<span class="op">:</span> (context<span class="op">,</span> state) <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (state <span class="kw">is</span> NoteLoading) <span class="op">{</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span> Center(child<span class="op">:</span> CircularProgressIndicator());</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (state <span class="kw">is</span> NoteLoaded) <span class="op">{</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span> NotesList(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            notes<span class="op">:</span> state<span class="op">.</span>notes<span class="op">,</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            syncStatus<span class="op">:</span> state<span class="op">.</span>syncStatus<span class="op">,</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>          );</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (state <span class="kw">is</span> NoteSyncError) <span class="op">{</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span> ErrorWidget(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>            error<span class="op">:</span> state<span class="op">.</span>error<span class="op">,</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            onRetry<span class="op">:</span> () <span class="op">=&gt;</span> context<span class="op">.</span>read<span class="op">&lt;</span>NoteBloc<span class="op">&gt;</span>()<span class="op">.</span>add(SyncNotesEvent())<span class="op">,</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>          );</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (state <span class="kw">is</span> NoteConflictDetected) <span class="op">{</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>          <span class="kw">return</span> ConflictResolutionDialog(</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>            localNote<span class="op">:</span> state<span class="op">.</span>localNote<span class="op">,</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>            serverNote<span class="op">:</span> state<span class="op">.</span>serverNote<span class="op">,</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            conflictReason<span class="op">:</span> state<span class="op">.</span>conflictReason<span class="op">,</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            onResolve<span class="op">:</span> (resolution) <span class="op">{</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>              <span class="co">// Handle conflict resolution</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>          );</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Container();</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">},</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotesList <span class="kw">extends</span> StatelessWidget <span class="op">{</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">List</span><span class="op">&lt;</span>Note<span class="op">&gt;</span> notes;</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncStatus syncStatus;</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> NotesList(<span class="op">{</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>notes<span class="op">,</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    required <span class="kw">this</span><span class="op">.</span>syncStatus<span class="op">,</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>);</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) <span class="op">{</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Column(</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>      children<span class="op">:</span> [</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sync status indicator</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        SyncStatusIndicator(status<span class="op">:</span> syncStatus)<span class="op">,</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Notes list</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>        Expanded(</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>          child<span class="op">:</span> ListView<span class="op">.</span>builder(</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>            itemCount<span class="op">:</span> notes<span class="op">.</span>length<span class="op">,</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            itemBuilder<span class="op">:</span> (context<span class="op">,</span> index) <span class="op">{</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">final</span> note <span class="op">=</span> notes[index];</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>              <span class="kw">return</span> NoteCard(</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>                note<span class="op">:</span> note<span class="op">,</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>                onEdit<span class="op">:</span> () <span class="op">=&gt;</span> _editNote(context<span class="op">,</span> note)<span class="op">,</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>                onDelete<span class="op">:</span> () <span class="op">=&gt;</span> _deleteNote(context<span class="op">,</span> note)<span class="op">,</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>              );</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>          )<span class="op">,</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">,</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _editNote(BuildContext context<span class="op">,</span> Note note) <span class="op">{</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Navigate to edit screen</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> _deleteNote(BuildContext context<span class="op">,</span> Note note) <span class="op">{</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span>read<span class="op">&lt;</span>NoteBloc<span class="op">&gt;</span>()<span class="op">.</span>add(DeleteNoteEvent(note<span class="op">.</span>id));</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="sync-status-indicator">4. Sync Status Indicator</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode dart"><code class="sourceCode dart"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncStatusIndicator <span class="kw">extends</span> StatelessWidget <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> SyncStatus status;</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> SyncStatusIndicator(<span class="op">{</span>required <span class="kw">this</span><span class="op">.</span>status<span class="op">}</span>);</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">@override</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  Widget build(BuildContext context) <span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Container(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      padding<span class="op">:</span> EdgeInsets<span class="op">.</span>all(<span class="fl">8.0</span>)<span class="op">,</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      child<span class="op">:</span> Row(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        children<span class="op">:</span> [</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>          Icon(</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            _getStatusIcon()<span class="op">,</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            color<span class="op">:</span> _getStatusColor()<span class="op">,</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            size<span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>          )<span class="op">,</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>          SizedBox(width<span class="op">:</span> <span class="dv">8</span>)<span class="op">,</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>          Text(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            _getStatusText()<span class="op">,</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            style<span class="op">:</span> TextStyle(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>              color<span class="op">:</span> _getStatusColor()<span class="op">,</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>              fontSize<span class="op">:</span> <span class="dv">12</span><span class="op">,</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            )<span class="op">,</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>          )<span class="op">,</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        ]<span class="op">,</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>      )<span class="op">,</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    );</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  IconData _getStatusIcon() <span class="op">{</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (status) <span class="op">{</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>idle<span class="op">:</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Icons<span class="op">.</span>check_circle;</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>syncing<span class="op">:</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Icons<span class="op">.</span><span class="kw">sync</span>;</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>error<span class="op">:</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Icons<span class="op">.</span>error;</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>conflict<span class="op">:</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Icons<span class="op">.</span>warning;</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  Color _getStatusColor() <span class="op">{</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (status) <span class="op">{</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>idle<span class="op">:</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Colors<span class="op">.</span>green;</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>syncing<span class="op">:</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Colors<span class="op">.</span>blue;</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>error<span class="op">:</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Colors<span class="op">.</span>red;</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>conflict<span class="op">:</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Colors<span class="op">.</span>orange;</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">String</span> _getStatusText() <span class="op">{</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (status) <span class="op">{</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>idle<span class="op">:</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&#39;All synced&#39;</span>;</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>syncing<span class="op">:</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&#39;Syncing...&#39;</span>;</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>error<span class="op">:</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&#39;Sync error&#39;</span>;</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> SyncStatus<span class="op">.</span>conflict<span class="op">:</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&#39;Conflict detected&#39;</span>;</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="dependencies-pubspec.yaml">5. Dependencies (pubspec.yaml)</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">flutter</span><span class="kw">:</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sdk</span><span class="kw">:</span><span class="at"> flutter</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hive</span><span class="kw">:</span><span class="at"> ^2.2.3</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hive_flutter</span><span class="kw">:</span><span class="at"> ^1.1.0</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">flutter_bloc</span><span class="kw">:</span><span class="at"> ^8.1.3</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">connectivity_plus</span><span class="kw">:</span><span class="at"> ^5.0.2</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">uuid</span><span class="kw">:</span><span class="at"> ^4.2.1</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">dio</span><span class="kw">:</span><span class="at"> ^5.4.0</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workmanager</span><span class="kw">:</span><span class="at"> ^0.5.2</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">equatable</span><span class="kw">:</span><span class="at"> ^2.0.5</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dev_dependencies</span><span class="kw">:</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">flutter_test</span><span class="kw">:</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sdk</span><span class="kw">:</span><span class="at"> flutter</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">hive_generator</span><span class="kw">:</span><span class="at"> ^2.0.1</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build_runner</span><span class="kw">:</span><span class="at"> ^2.4.7</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bloc_test</span><span class="kw">:</span><span class="at"> ^9.1.5</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mockito</span><span class="kw">:</span><span class="at"> ^5.4.2</span></span></code></pre></div>
<hr />
<h2 id="best-practices">Best Practices</h2>
<h3 id="state-management">1. State Management</h3>
<ul>
<li>Use BLoC for complex state management</li>
<li>Use Cubit for simple state management</li>
<li>Keep BLoCs focused on single features</li>
<li>Use Equatable for state comparison</li>
<li>Emit states in the correct order</li>
</ul>
<h3 id="data-persistence">2. Data Persistence</h3>
<ul>
<li>Use Hive for local storage</li>
<li>Implement proper data adapters</li>
<li>Handle data migration gracefully</li>
<li>Use transactions for batch operations</li>
<li>Implement proper error handling</li>
</ul>
<h3 id="sync-engine">3. Sync Engine</h3>
<ul>
<li>Implement exponential backoff for retries</li>
<li>Use batch sync to reduce API calls</li>
<li>Handle conflicts gracefully</li>
<li>Provide user feedback for sync status</li>
<li>Implement proper error recovery</li>
</ul>
<h3 id="conflict-resolution-1">4. Conflict Resolution</h3>
<ul>
<li>Implement multiple resolution strategies</li>
<li>Provide user choice for critical conflicts</li>
<li>Log conflict resolution decisions</li>
<li>Test conflict scenarios thoroughly</li>
<li>Document resolution policies</li>
</ul>
<h3 id="error-handling">5. Error Handling</h3>
<ul>
<li>Implement comprehensive error handling</li>
<li>Provide meaningful error messages</li>
<li>Log errors for debugging</li>
<li>Implement retry mechanisms</li>
<li>Handle network failures gracefully</li>
</ul>
<h3 id="testing">6. Testing</h3>
<ul>
<li>Write unit tests for BLoCs</li>
<li>Test repository implementations</li>
<li>Mock external dependencies</li>
<li>Test offline/online scenarios</li>
<li>Test conflict resolution</li>
</ul>
<h3 id="performance">7. Performance</h3>
<ul>
<li>Use lazy loading for large datasets</li>
<li>Implement pagination</li>
<li>Optimize Hive queries</li>
<li>Use background sync</li>
<li>Monitor memory usage</li>
</ul>
<h3 id="security">8. Security</h3>
<ul>
<li>Encrypt sensitive data</li>
<li>Use secure storage</li>
<li>Implement proper authentication</li>
<li>Validate all inputs</li>
<li>Handle sensitive data properly</li>
</ul>
<hr />
<p>This comprehensive architecture provides a robust, production-ready
foundation for a Flutter offline-first application using BLoC, Hive, and
a dedicated sync engine. The design ensures reliable offline
functionality with proper conflict resolution and state management.</p>
